"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.addE2e = void 0;
const devkit_1 = require("@nx/devkit");
const eslint_1 = require("@nx/eslint");
const versions_1 = require("../../../utils/versions");
const web_1 = require("@nx/web");
async function addE2e(host, options) {
    const nxJson = (0, devkit_1.readNxJson)(host);
    const hasPlugin = nxJson.plugins?.some((p) => typeof p === 'string'
        ? p === '@nx/next/plugin'
        : p.plugin === '@nx/next/plugin');
    if (options.e2eTestRunner === 'cypress') {
        const { configurationGenerator } = (0, devkit_1.ensurePackage)('@nx/cypress', versions_1.nxVersion);
        if (!hasPlugin) {
            await (0, web_1.webStaticServeGenerator)(host, {
                buildTarget: `${options.projectName}:build`,
                outputPath: `${options.outputPath}/out`,
                targetName: 'serve-static',
                spa: true,
            });
        }
        (0, devkit_1.addProjectConfiguration)(host, options.e2eProjectName, {
            root: options.e2eProjectRoot,
            sourceRoot: (0, devkit_1.joinPathFragments)(options.e2eProjectRoot, 'src'),
            targets: {},
            tags: [],
            implicitDependencies: [options.projectName],
        });
        return configurationGenerator(host, {
            ...options,
            linter: eslint_1.Linter.EsLint,
            project: options.e2eProjectName,
            directory: 'src',
            skipFormat: true,
            devServerTarget: `${options.projectName}:${options.e2eWebServerTarget}`,
            baseUrl: options.e2eWebServerAddress,
            jsx: true,
            webServerCommands: hasPlugin
                ? {
                    default: `nx run ${options.projectName}:${options.e2eWebServerTarget}`,
                }
                : undefined,
            ciWebServerCommand: hasPlugin
                ? `nx run ${options.projectName}:serve-static`
                : undefined,
        });
    }
    else if (options.e2eTestRunner === 'playwright') {
        const { configurationGenerator } = (0, devkit_1.ensurePackage)('@nx/playwright', versions_1.nxVersion);
        (0, devkit_1.addProjectConfiguration)(host, options.e2eProjectName, {
            root: options.e2eProjectRoot,
            sourceRoot: (0, devkit_1.joinPathFragments)(options.e2eProjectRoot, 'src'),
            targets: {},
            tags: [],
            implicitDependencies: [options.projectName],
        });
        return configurationGenerator(host, {
            rootProject: options.rootProject,
            project: options.e2eProjectName,
            skipFormat: true,
            skipPackageJson: options.skipPackageJson,
            directory: 'src',
            js: false,
            linter: options.linter,
            setParserOptionsProject: options.setParserOptionsProject,
            webServerAddress: `http://127.0.0.1:${options.e2ePort}`,
            webServerCommand: `${(0, devkit_1.getPackageManagerCommand)().exec} nx ${options.e2eWebServerTarget} ${options.projectName}`,
            addPlugin: options.addPlugin,
        });
    }
    return () => { };
}
exports.addE2e = addE2e;
